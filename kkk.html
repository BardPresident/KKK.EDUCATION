<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ Kalos Kratos Kleos üéµ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600&family=EB+Garamond:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #d4af37;
            --gold-bright: #ffd700;
            --gold-dim: #8b7020;
            --black: #0a0a0a;
            --dark: #111108;
            --surface: #1a1a10;
            --surface2: #222215;
            --text: #e8d5a3;
            --text-dim: #8a7a50;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--black);
            color: var(--text);
            font-family: 'EB Garamond', serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 400px;
            background: radial-gradient(ellipse at 50% -20%, rgba(212,175,55,0.12) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .candles {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .spark {
            position: absolute;
            width: 2px; height: 2px;
            border-radius: 50%;
            background: var(--gold);
            animation: float-up linear infinite;
            opacity: 0;
        }

        @keyframes float-up {
            0% { transform: translateY(100vh) translateX(0); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.2; }
            100% { transform: translateY(-20px) translateX(20px); opacity: 0; }
        }

        .back-link {
            position: fixed;
            top: 20px; left: 20px;
            color: #ffffff;
            text-decoration: none;
            font-family: 'Cinzel', serif;
            font-size: 0.8em;
            letter-spacing: 0.1em;
            transition: color 0.3s;
            z-index: 100;
        }
        .back-link:hover { color: var(--gold); }

        .sanctuary {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 60px 20px 40px;
        }

        .altar {
            text-align: center;
            margin-bottom: 50px;
            position: relative;
        }

        .altar::before, .altar::after {
            content: '‚ú¶';
            color: var(--gold-dim);
            font-size: 1.5em;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        .altar::before { left: -60px; }
        .altar::after { right: -60px; }

        .altar h1 {
            font-family: 'Cinzel Decorative', serif;
            font-size: clamp(1.8em, 5vw, 3.2em);
            font-weight: 900;
            color: var(--gold);
            text-shadow: 0 0 40px rgba(212,175,55,0.6), 0 0 80px rgba(212,175,55,0.2);
            letter-spacing: 0.05em;
            line-height: 1.2;
            animation: glow-pulse 4s ease-in-out infinite;
        }

        @keyframes glow-pulse {
            0%, 100% { text-shadow: 0 0 40px rgba(212,175,55,0.6), 0 0 80px rgba(212,175,55,0.2); }
            50% { text-shadow: 0 0 60px rgba(212,175,55,0.9), 0 0 120px rgba(212,175,55,0.4); }
        }

        .altar .subtitle {
            font-family: 'EB Garamond', serif;
            font-size: 1.05em;
            letter-spacing: 0.02em;
            color: #d4c5a0;
            margin-top: 16px;
            text-transform: none;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
            line-height: 1.9;
            padding: 0 10px;
        }

        .divider {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            width: 100%;
            max-width: 400px;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--gold-dim), transparent);
        }
        .divider-symbol { color: var(--gold); font-size: 1.2em; }

        .player-container {
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .now-playing-card {
            background: var(--surface);
            border: 2px solid var(--gold-dim);
            border-radius: 4px;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(212,175,55,0.1), inset 0 0 60px rgba(0,0,0,0.5);
        }

        .now-playing-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(212,175,55,0.03) 0%, transparent 50%),
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(212,175,55,0.01) 10px, rgba(212,175,55,0.01) 11px);
            pointer-events: none;
        }

        .track-status {
            font-family: 'Cinzel', serif;
            font-size: 0.65em;
            letter-spacing: 0.4em;
            color: var(--gold-dim);
            text-transform: uppercase;
            margin-bottom: 15px;
        }

        .track-status.playing {
            color: var(--gold);
            animation: status-pulse 1.5s ease-in-out infinite;
        }

        @keyframes status-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .track-number {
            font-family: 'Cinzel', serif;
            font-size: 0.75em;
            color: var(--gold-dim);
            margin-bottom: 8px;
            letter-spacing: 0.2em;
        }

        .track-name {
            font-family: 'Cinzel Decorative', serif;
            font-size: clamp(1em, 3vw, 1.6em);
            color: var(--gold);
            line-height: 1.3;
            margin-bottom: 8px;
            min-height: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .visualizer {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
            height: 40px;
            margin: 15px 0;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .visualizer.active { opacity: 1; }

        .viz-bar {
            width: 4px;
            background: var(--gold);
            border-radius: 2px 2px 0 0;
            animation: viz-dance linear infinite;
            transform-origin: bottom;
        }

        @keyframes viz-dance {
            0%, 100% { transform: scaleY(0.1); }
            50% { transform: scaleY(1); }
        }

        .progress-section { margin-top: 20px; }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: var(--text-dim);
            margin-bottom: 8px;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.05em;
        }

        .progress-track {
            width: 100%;
            height: 4px;
            background: var(--surface2);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            overflow: visible;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--gold-dim), var(--gold));
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: -5px; top: -4px;
            width: 12px; height: 12px;
            background: var(--gold);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(212,175,55,0.8);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .progress-track:hover .progress-fill::after { opacity: 1; }

        .controls-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 25px;
        }

        .ctrl-btn {
            background: none; border: none;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.2s;
            padding: 8px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1em;
        }
        .ctrl-btn:hover { color: var(--gold); transform: scale(1.1); }
        .ctrl-btn.active { color: var(--gold); }
        .ctrl-btn svg { width: 22px; height: 22px; fill: currentColor; }

        .play-btn {
            width: 64px; height: 64px;
            background: var(--surface2);
            border: 2px solid var(--gold);
            border-radius: 50%;
            cursor: pointer;
            color: var(--gold);
            transition: all 0.3s;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(212,175,55,0.2);
        }
        .play-btn:hover {
            background: rgba(212,175,55,0.15);
            box-shadow: 0 0 30px rgba(212,175,55,0.4);
            transform: scale(1.05);
        }
        .play-btn svg { width: 28px; height: 28px; fill: currentColor; }

        .volume-row {
            display: flex; align-items: center;
            gap: 12px; justify-content: center;
            margin-top: 15px;
        }
        .volume-row svg { width: 18px; height: 18px; fill: var(--text-dim); }

        input[type="range"] {
            -webkit-appearance: none;
            width: 120px; height: 3px;
            background: var(--surface2);
            border-radius: 2px;
            cursor: pointer; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            border-radius: 50%;
            background: var(--gold);
            cursor: pointer;
            box-shadow: 0 0 6px rgba(212,175,55,0.6);
        }

        .tracklist-card {
            background: var(--surface);
            border: 1px solid var(--gold-dim);
            border-radius: 4px;
            overflow: hidden;
        }

        .tracklist-header {
            padding: 15px 20px;
            background: var(--surface2);
            border-bottom: 1px solid var(--gold-dim);
            display: flex; align-items: center; justify-content: space-between;
        }
        .tracklist-header h3 {
            font-family: 'Cinzel', serif;
            font-size: 0.75em;
            letter-spacing: 0.3em;
            color: var(--gold);
            text-transform: uppercase;
        }
        .track-count {
            font-family: 'Cinzel', serif;
            font-size: 0.7em;
            color: var(--text-dim);
            letter-spacing: 0.1em;
        }

        .tracklist-body { max-height: 320px; overflow-y: auto; }
        .tracklist-body::-webkit-scrollbar { width: 4px; }
        .tracklist-body::-webkit-scrollbar-track { background: var(--surface); }
        .tracklist-body::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 2px; }

        .track-item {
            display: flex; align-items: center;
            gap: 15px; padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(212,175,55,0.05);
            transition: background 0.2s;
        }
        .track-item:hover { background: rgba(212,175,55,0.05); }
        .track-item.active {
            background: rgba(212,175,55,0.1);
            border-left: 3px solid var(--gold);
            padding-left: 17px;
        }

        .track-num {
            font-family: 'Cinzel', serif;
            font-size: 0.7em; color: var(--text-dim);
            min-width: 24px; text-align: right;
        }
        .track-item.active .track-num { color: var(--gold); }

        .track-item-name {
            flex: 1; font-size: 0.95em; color: var(--text);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .track-item.active .track-item-name { color: var(--gold); }

        .track-item-dur {
            font-family: 'Cinzel', serif;
            font-size: 0.7em; color: var(--text-dim);
        }

        .playing-indicator {
            display: none; gap: 2px;
            align-items: flex-end; height: 16px;
        }
        .track-item.active .playing-indicator { display: flex; }
        .track-item.active .track-num { display: none; }

        .playing-indicator span {
            width: 3px; background: var(--gold);
            border-radius: 1px;
            animation: mini-viz linear infinite;
        }
        .playing-indicator span:nth-child(1) { animation-duration: 0.6s; animation-delay: 0s; height: 8px; }
        .playing-indicator span:nth-child(2) { animation-duration: 0.8s; animation-delay: 0.1s; height: 12px; }
        .playing-indicator span:nth-child(3) { animation-duration: 0.5s; animation-delay: 0.2s; height: 6px; }

        @keyframes mini-viz {
            0%, 100% { transform: scaleY(0.3); }
            50% { transform: scaleY(1); }
        }

        .state-msg {
            text-align: center; padding: 40px 20px;
            color: var(--text-dim); font-style: italic; font-size: 1em;
        }

        .footer-motto {
            margin-top: 40px; text-align: center;
            font-family: 'Cinzel', serif;
            font-size: 0.7em; letter-spacing: 0.2em;
            color: var(--gold); line-height: 2;
        }

        @media (max-width: 600px) {
            .sanctuary { padding: 50px 15px 30px; }
            .now-playing-card { padding: 20px 15px; }
            .controls-row { gap: 12px; }
            .play-btn { width: 56px; height: 56px; }
        }
    </style>
</head>
<body>

<div class="candles" id="candles"></div>

<a href="index.html" class="back-link">‚Üê HOME</a>

<div class="sanctuary">

    <div class="altar">
        <h1>üéµ <br>Kalos<br>Kratos<br>Kleos</h1>
        <div class="subtitle">Sacred Songs of the Republic<br>February 16<br>0002 MC<br><br>Ivory sings. Her voice carries the great love stories of myth, scripture, and soul ‚Äî from underworld descents to impossible reunions, from stone turned to flesh, from grief transmuted into gold. Each song is a prayer, each melody a thread pulled from the Loom of creation. These are not performances; they are transmissions. Whether she is singing ancient hymns of the Republic or new kabbalistic spells, Ivory moves through crowns, crosses, and underworlds with the same vow: to give sound to love that refuses to die, love that returns from Hades, love that finds what was lost and binds souls across lifetimes.<br><br>Kry Kry Kry. The tears are the most powerful magicka.</div>
    </div>

    <div class="divider">
        <span class="divider-symbol">‚ù¶</span>
    </div>

    <div class="player-container">

        <div class="now-playing-card">
            <div class="track-status" id="trackStatus">‚∏ª AWAITING ‚∏ª</div>
            <div class="track-number" id="trackNumber">‚Äî</div>
            <div class="track-name" id="trackName">Select a hymn to begin</div>

            <div class="visualizer" id="visualizer"></div>

            <div class="progress-section">
                <div class="time-display">
                    <span id="timeElapsed">0:00</span>
                    <span id="timeDuration">0:00</span>
                </div>
                <div class="progress-track" id="progressTrack">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="controls-row">
                <button class="ctrl-btn" id="shuffleBtn" title="Shuffle" onclick="toggleShuffle()">
                    <svg viewBox="0 0 24 24"><path d="M17 4l4 4-4 4V9h-1.08C13.63 9 12.27 9.83 11 11.25 9.73 9.83 8.37 9 6.92 9H3V7h3.92c1.12 0 2.16.76 3.22 2.06C11.38 7.71 13.08 7 14.92 7H17V4zm-6.56 8.81C9.22 14.17 8.18 15 6.92 15H3v-2h3.92c.7 0 1.39-.43 2.1-1.25.1-.12.21-.24.32-.37-.28-.38-.56-.73-.86-1.06-.1.12-.21.23-.31.34-.1.12-.21.23-.31.34zM17 20v-3h-2.08c-1.84 0-3.54-.71-4.84-2.06-1.06 1.36-2.1 2.06-3.22 2.06H3v-2h3.92c1.45 0 2.81-.83 4.08-2.25C12.27 14.17 13.63 15 14.92 15H17v-3l4 4-4 4z"/></svg>
                </button>
                <button class="ctrl-btn" title="Previous" onclick="prevTrack()">
                    <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                </button>
                <button class="play-btn" id="playBtn" onclick="togglePlay()">
                    <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button class="ctrl-btn" title="Next" onclick="nextTrack()">
                    <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zm2-8.14L11.03 12 8 14.14V9.86zM16 6h2v12h-2z"/></svg>
                </button>
                <button class="ctrl-btn" id="repeatBtn" title="Repeat" onclick="cycleRepeat()">
                    <svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
                </button>
            </div>

            <div class="volume-row">
                <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                <input type="range" id="volumeSlider" min="0" max="100" value="80" oninput="setVolume(this.value)">
                <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            </div>
        </div>

        <div class="tracklist-card">
            <div class="tracklist-header">
                <h3>üïØ Hymnal</h3>
                <span class="track-count" id="trackCount">Loading...</span>
            </div>
            <div class="tracklist-body" id="trackList">
                <div class="state-msg">Loading hymns...</div>
            </div>
        </div>

    </div>

    <div style="text-align:center;margin-top:30px;padding:20px;border:1px solid var(--gold-dim);background:rgba(212,175,55,0.05);border-radius:4px;">
        <div style="font-family:'Cinzel',serif;font-size:0.75em;letter-spacing:0.3em;color:var(--gold);margin-bottom:10px;">üì¶ SAVE THIS PLAYER</div>
        <p style="font-size:0.85em;color:var(--text-dim);margin-bottom:14px;line-height:1.6;">Save this page and open it anywhere.<br>It will always stream music from the live server.</p>
        <button onclick="window.open('https://kkk.education/kkk.html','_blank')" style="padding:8px 20px;background:none;border:1px solid var(--gold-dim);color:var(--gold-dim);font-family:'Cinzel',serif;font-size:0.7em;letter-spacing:0.2em;cursor:pointer;margin:4px;">üåê OPEN LIVE VERSION</button>
        <button onclick="saveThisPage()" style="padding:8px 20px;background:none;border:1px solid var(--gold-dim);color:var(--gold-dim);font-family:'Cinzel',serif;font-size:0.7em;letter-spacing:0.2em;cursor:pointer;margin:4px;">üíæ SAVE THIS FILE</button>
    </div>

    <div class="footer-motto">
        KRY KRY KRY ¬∑ THE TEARS ARE THE MOST POWERFUL MAGICKA<br>
        CC0 PUBLICK√Å DOM√ÅNIA ¬∑ ALL LOVE RESERVED ¬∑ AMORIARIACKA
    </div>

</div>

<audio id="audioEl"></audio>

<script>
    const MANIFEST_URL = 'manifest.json';
    const HYMNS_FOLDER = 'Kalos-Kratos-Kleos';
    const HYMNS_PATH   = 'cinema/Kalos-Kratos-Kleos';

    let tracks = [];
    let currentIndex = -1;
    let isPlaying = false;
    let shuffle = false;
    let repeatMode = 0;
    let shuffleOrder = [];
    let durations = {};

    const audio = document.getElementById('audioEl');

    async function init() {
        try {
            var manifest;

            // Self-contained: use embedded manifest if present (saved/offline copy)
            if (window.EMBEDDED_MANIFEST) {
                manifest = window.EMBEDDED_MANIFEST;
            } else {
                var res = await fetch(MANIFEST_URL);
                if (!res.ok) throw new Error('not found');
                manifest = await res.json();
            }

            // Try name search first, then path search for cinema/subfolder structure
            var hymnFolder = findFolder(manifest.items, HYMNS_FOLDER) || findByPath(manifest.items, HYMNS_PATH);
            if (!hymnFolder) {
                showTrackListError('‚ö†Ô∏è Audio folder "' + HYMNS_FOLDER + '" not found in manifest.');
                return;
            }

            tracks = hymnFolder.children
                .filter(function(f) { return f.type === 'file' && /\.(mp3|wav|ogg|flac|m4a|aac)$/i.test(f.name); })
                .sort(function(a, b) { return a.name.localeCompare(b.name); });

            renderTrackList();
            if (tracks.length > 0) loadTrack(0, false);

        } catch(e) {
            showTrackListError(
                '‚ö†Ô∏è Could not load manifest.json<br><br>' +
                '<small>On the live site: make sure <strong>manifest.json</strong> exists in the root directory alongside this file.<br>' +
                'In the offline toolkit: the manifest should be embedded automatically when you download the zip from index.html.</small>'
            );
        }
    }

    function findByPath(items, path) {
        var parts = path.split('/');
        var current = items;
        for (var p = 0; p < parts.length; p++) {
            var match = null;
            for (var i = 0; i < current.length; i++) {
                if (current[i].type === 'folder' && current[i].name === parts[p]) { match = current[i]; break; }
            }
            if (!match) return null;
            current = match.children || [];
        }
        return { type: 'folder', name: parts[parts.length-1], children: current };
    }

    function findFolder(items, name) {
        for (var i = 0; i < items.length; i++) {
            var item = items[i];
            if (item.type === 'folder' && item.name === name) return item;
            if (item.type === 'folder' && item.children) {
                var found = findFolder(item.children, name);
                if (found) return found;
            }
        }
        return null;
    }

    function renderTrackList() {
        var list = document.getElementById('trackList');
        document.getElementById('trackCount').textContent = tracks.length + ' hymns';
        if (tracks.length === 0) {
            list.innerHTML = '<div class="state-msg">No audio files found in ' + HYMNS_FOLDER + '</div>';
            return;
        }
        list.innerHTML = tracks.map(function(t, i) {
            return '<div class="track-item" id="track-item-' + i + '" onclick="loadTrack(' + i + ', true)">' +
                '<div class="playing-indicator"><span></span><span></span><span></span></div>' +
                '<div class="track-num">' + (i+1) + '</div>' +
                '<div class="track-item-name">' + cleanName(t.name) + '</div>' +
                '<div class="track-item-dur" id="dur-' + i + '">‚Äî</div>' +
            '</div>';
        }).join('');
        preloadDurations();
    }

    function showTrackListError(msg) {
        document.getElementById('trackList').innerHTML = '<div class="state-msg">' + msg + '</div>';
        document.getElementById('trackCount').textContent = '0 hymns';
    }

    function cleanName(filename) {
        return filename.replace(/\.(mp3|wav|ogg|flac|m4a|aac)$/i, '')
                       .replace(/[-_]/g, ' ')
                       .replace(/^\d+[\s.-]+/, '');
    }

    function loadTrack(index, autoPlay) {
        if (index < 0 || index >= tracks.length) return;
        currentIndex = index;
        var t = tracks[index];
        audio.src = t.path;
        audio.load();

        document.getElementById('trackName').textContent = cleanName(t.name);
        document.getElementById('trackNumber').textContent = 'Hymn ' + (index + 1) + ' of ' + tracks.length;
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('timeElapsed').textContent = '0:00';
        document.getElementById('timeDuration').textContent = durations[index] || '‚Äî';

        highlightActive(index);

        if (autoPlay) {
            audio.play().then(function() { setPlayingState(true); }).catch(function() { setPlayingState(false); });
        } else {
            setPlayingState(false);
        }
    }

    function highlightActive(index) {
        document.querySelectorAll('.track-item').forEach(function(el, i) {
            el.classList.toggle('active', i === index);
        });
        var el = document.getElementById('track-item-' + index);
        if (el) el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }

    function setPlayingState(playing) {
        isPlaying = playing;
        var playIcon = document.getElementById('playIcon');
        var status   = document.getElementById('trackStatus');
        var viz      = document.getElementById('visualizer');

        if (playing) {
            playIcon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
            status.textContent = '‚ô™ NOW PLAYING ‚ô™';
            status.classList.add('playing');
            viz.classList.add('active');
        } else {
            playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
            status.textContent = '‚∏ª PAUSED ‚∏ª';
            status.classList.remove('playing');
            viz.classList.remove('active');
        }
    }

    function togglePlay() {
        if (tracks.length === 0) return;
        if (currentIndex === -1) { loadTrack(0, true); return; }
        if (isPlaying) {
            audio.pause(); setPlayingState(false);
        } else {
            audio.play().then(function() { setPlayingState(true); });
        }
    }

    function nextTrack() {
        if (tracks.length === 0) return;
        var next = shuffle ? getShuffleNext() : (currentIndex + 1) % tracks.length;
        loadTrack(next, isPlaying);
    }

    function prevTrack() {
        if (tracks.length === 0) return;
        if (audio.currentTime > 3) { audio.currentTime = 0; return; }
        loadTrack((currentIndex - 1 + tracks.length) % tracks.length, isPlaying);
    }

    function toggleShuffle() {
        shuffle = !shuffle;
        document.getElementById('shuffleBtn').classList.toggle('active', shuffle);
        if (shuffle) buildShuffleOrder();
    }

    function buildShuffleOrder() {
        shuffleOrder = [];
        for (var i = 0; i < tracks.length; i++) { if (i !== currentIndex) shuffleOrder.push(i); }
        for (var i = shuffleOrder.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var tmp = shuffleOrder[i]; shuffleOrder[i] = shuffleOrder[j]; shuffleOrder[j] = tmp;
        }
    }

    function getShuffleNext() {
        if (shuffleOrder.length === 0) buildShuffleOrder();
        return shuffleOrder.shift();
    }

    var repeatIcons = [
        '<path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/>',
        '<path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/>',
        '<path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4zm-4-8v6h-1.5v-4.5H10V9h.5l2-1.5V9H13z"/>'
    ];

    function cycleRepeat() {
        repeatMode = (repeatMode + 1) % 3;
        var btn = document.getElementById('repeatBtn');
        btn.classList.toggle('active', repeatMode > 0);
        btn.querySelector('svg').innerHTML = repeatIcons[repeatMode];
    }

    audio.addEventListener('timeupdate', function() {
        if (!audio.duration) return;
        var pct = (audio.currentTime / audio.duration) * 100;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('timeElapsed').textContent = formatTime(audio.currentTime);
    });

    audio.addEventListener('loadedmetadata', function() {
        document.getElementById('timeDuration').textContent = formatTime(audio.duration);
        if (currentIndex >= 0) {
            durations[currentIndex] = formatTime(audio.duration);
            var el = document.getElementById('dur-' + currentIndex);
            if (el) el.textContent = durations[currentIndex];
        }
    });

    audio.addEventListener('ended', function() {
        if (repeatMode === 2) { audio.currentTime = 0; audio.play(); }
        else if (repeatMode === 1) { nextTrack(); }
        else {
            var isLast = !shuffle && (currentIndex === tracks.length - 1);
            if (!isLast) nextTrack(); else setPlayingState(false);
        }
    });

    audio.volume = 0.8;

    document.getElementById('progressTrack').addEventListener('click', function(e) {
        if (!audio.duration) return;
        var rect = e.currentTarget.getBoundingClientRect();
        audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
    });

    function setVolume(val) { audio.volume = val / 100; }

    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT') return;
        if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
        if (e.code === 'ArrowRight') nextTrack();
        if (e.code === 'ArrowLeft') prevTrack();
        if (e.code === 'ArrowUp') { audio.volume = Math.min(1, audio.volume + 0.1); document.getElementById('volumeSlider').value = audio.volume * 100; }
        if (e.code === 'ArrowDown') { audio.volume = Math.max(0, audio.volume - 0.1); document.getElementById('volumeSlider').value = audio.volume * 100; }
    });

    function formatTime(s) {
        if (!s || isNaN(s)) return '0:00';
        var m = Math.floor(s / 60);
        var sec = Math.floor(s % 60).toString().padStart(2, '0');
        return m + ':' + sec;
    }

    function preloadDurations() {
        for (var i = 0; i < tracks.length; i++) {
            (function(idx) {
                var tmp = new Audio();
                tmp.preload = 'metadata';
                tmp.src = tracks[idx].path;
                tmp.addEventListener('loadedmetadata', function() {
                    durations[idx] = formatTime(tmp.duration);
                    var el = document.getElementById('dur-' + idx);
                    if (el) el.textContent = durations[idx];
                }, { once: true });
            })(i);
        }
    }

    function buildVisualizer() {
        var viz = document.getElementById('visualizer');
        for (var i = 0; i < 20; i++) {
            var bar = document.createElement('div');
            bar.className = 'viz-bar';
            bar.style.height = (Math.random() * 30 + 5) + 'px';
            bar.style.animationDuration = (Math.random() * 0.6 + 0.4) + 's';
            bar.style.animationDelay = (Math.random() * 0.5) + 's';
            bar.style.opacity = (0.4 + Math.random() * 0.6).toString();
            viz.appendChild(bar);
        }
    }

    function buildSparks() {
        var container = document.getElementById('candles');
        for (var i = 0; i < 25; i++) {
            var s = document.createElement('div');
            s.className = 'spark';
            s.style.left = Math.random() * 100 + '%';
            s.style.animationDuration = (Math.random() * 8 + 6) + 's';
            s.style.animationDelay = (Math.random() * 10) + 's';
            s.style.width = s.style.height = (Math.random() * 2 + 1) + 'px';
            s.style.opacity = (Math.random() * 0.4 + 0.1).toString();
            container.appendChild(s);
        }
    }


    async function saveThisPage() {
        try {
            // Fetch the page source and the manifest in parallel
            var [pageRes, manifestRes] = await Promise.all([
                fetch('https://kkk.education/kkk.html'),
                fetch('https://kkk.education/manifest.json')
            ]);
            var pageText = await pageRes.text();
            var manifestText = await manifestRes.text();
            // Embed manifest so saved file works with no internet
            var injection = '<scr' + 'ipt>window.EMBEDDED_MANIFEST=' + manifestText + ';</scr' + 'ipt>';
            pageText = pageText.replace('</head>', injection + '</head>');
            var blob = new Blob([pageText], {type:'text/html'});
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'kkk.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        } catch(e) {
            alert('Save failed: ' + e.message + '\nTry File > Save Page As instead.');
        }
    }
    buildVisualizer();
    buildSparks();
    init();
</script>
</body>
</html>