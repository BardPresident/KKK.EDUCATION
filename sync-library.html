<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”” LIBRARY SYNC BELL ğŸ”” - KKK.EDUCATION</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #0a0414 0%, #1a0a2e 50%, #0a0414 100%); background-attachment: fixed; color: #d4af37; font-family: 'Crimson Text', serif; line-height: 1.6; overflow-x: hidden; min-height: 100vh; }
        body::after { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px), repeating-linear-gradient(90deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px); pointer-events: none; z-index: 2; opacity: 0.3; }
        .fog-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: hidden; }
        .fog { position: absolute; width: 200%; height: 200%; background: radial-gradient(ellipse at 20% 50%, rgba(75,0,130,0.25) 0%, transparent 40%), radial-gradient(ellipse at 80% 30%, rgba(50,0,80,0.2) 0%, transparent 50%), radial-gradient(ellipse at 50% 80%, rgba(60,10,100,0.3) 0%, transparent 45%); animation: fogMove 60s ease-in-out infinite; }
        .fog:nth-child(2) { animation: fogMove2 80s ease-in-out infinite; opacity: 0.8; }
        .fog:nth-child(3) { animation: fogMove3 100s ease-in-out infinite; opacity: 0.6; }
        @keyframes fogMove  { 0%,100%{transform:translate(-10%,-10%) rotate(0deg)}   50%{transform:translate(10%,10%) rotate(180deg)} }
        @keyframes fogMove2 { 0%,100%{transform:translate(10%,10%) rotate(180deg)}   50%{transform:translate(-10%,-10%) rotate(360deg)} }
        @keyframes fogMove3 { 0%,100%{transform:translate(-5%,10%) rotate(90deg)}    50%{transform:translate(5%,-10%) rotate(270deg)} }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, rgba(255,140,0,0.04) 0%, transparent 50%); animation: flicker 4s ease-in-out infinite; pointer-events: none; z-index: 0; }
        @keyframes flicker { 0%,100%{opacity:0.4} 25%{opacity:0.6} 50%{opacity:0.3} 75%{opacity:0.7} }
        .page-wrapper { position: relative; z-index: 10; }
        .header { text-align: center; padding: 40px 20px 30px; background: linear-gradient(180deg, rgba(26,10,46,0.95) 0%, transparent 100%); border-bottom: 3px solid rgba(212,175,55,0.4); box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .bell-icon { font-size: 100px; line-height: 1; text-shadow: 0 0 30px rgba(255,215,0,1), 0 0 60px rgba(255,140,0,0.9), 0 0 90px rgba(255,100,0,0.7), 0 5px 15px rgba(0,0,0,0.8); animation: bellSwing 3s ease-in-out infinite; display: inline-block; }
        @keyframes bellSwing { 0%,100%{transform:rotate(-15deg)} 50%{transform:rotate(15deg)} }
        .title { font-family: 'Cinzel', serif; font-size: 36px; font-weight: 900; letter-spacing: 5px; margin: 20px 0 10px; color: #ffd700; text-shadow: 0 0 20px rgba(255,215,0,0.8), 2px 2px 4px rgba(0,0,0,0.9); }
        .subtitle { font-size: 18px; font-style: italic; color: #b8860b; letter-spacing: 2px; }
        .content { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
        nav { text-align: center; margin-bottom: 20px; }
        nav a { display: inline-block; margin: 0 6px; padding: 0.7em 1.6em; border-radius: 999px; background: none; border: 2px solid rgba(255,255,255,0.4); color: #ffffff; text-decoration: none; font-weight: 700; letter-spacing: 0.08em; font-family: 'Cinzel', serif; font-size: 0.85em; transition: all 0.3s; }
        nav a:hover { border-color: #ffd700; color: #ffd700; }
        .auto-sync-panel { background: rgba(0,80,0,0.3); border: 3px solid rgba(0,255,100,0.5); padding: 30px; margin: 30px 0; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8), inset 0 0 30px rgba(0,80,0,0.3); }
        .auto-sync-title { font-family: 'Cinzel', serif; font-size: 26px; font-weight: 900; color: #00ff88; margin-bottom: 15px; letter-spacing: 3px; text-shadow: 0 0 15px rgba(0,255,136,0.6), 2px 2px 4px rgba(0,0,0,0.9); }
        .auto-sync-desc { font-size: 17px; color: #d4af37; margin-bottom: 20px; line-height: 1.8; }
        .auto-sync-button { display: inline-block; padding: 18px 50px; background: linear-gradient(135deg, rgba(0,139,0,0.6), rgba(0,180,80,0.6)); border: 3px solid #00ff88; color: #00ff88; font-family: 'Cinzel', serif; font-size: 22px; font-weight: 900; letter-spacing: 4px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(0,0,0,0.5), 0 0 30px rgba(0,255,136,0.3); }
        .auto-sync-button:hover { background: linear-gradient(135deg, rgba(0,180,80,0.8), rgba(0,220,100,0.8)); box-shadow: 0 0 50px rgba(0,255,136,0.6); transform: translateY(-2px); }
        .auto-sync-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .or-divider { text-align: center; font-family: 'Cinzel', serif; font-size: 22px; color: #8b4513; letter-spacing: 8px; margin: 10px 0; }
        .instructions { background: rgba(139,0,139,0.3); border: 3px solid rgba(255,100,255,0.4); padding: 30px; margin: 30px 0; box-shadow: 0 10px 40px rgba(0,0,0,0.8), inset 0 0 30px rgba(139,0,139,0.3); }
        .instructions h2 { font-family: 'Cinzel', serif; font-size: 24px; color: #ff69ff; margin-bottom: 20px; text-align: center; text-shadow: 0 0 15px rgba(255,100,255,0.6); }
        .instructions ol { margin-left: 30px; font-size: 18px; line-height: 2; }
        .instructions li { margin: 10px 0; }
        .drop-zone { background: rgba(10,4,20,0.8); border: 4px dashed rgba(212,175,55,0.6); padding: 80px 40px; margin: 40px 0; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 40px rgba(0,0,0,0.8), inset 0 0 30px rgba(0,0,0,0.5); }
        .drop-zone:hover, .drop-zone.drag-over { background: rgba(139,69,19,0.4); border-color: #ffd700; box-shadow: 0 10px 40px rgba(0,0,0,0.8), inset 0 0 30px rgba(255,215,0,0.2); }
        .drop-zone-icon { font-size: 80px; margin-bottom: 20px; }
        .drop-zone-text { font-family: 'Cinzel', serif; font-size: 24px; color: #ffd700; margin-bottom: 15px; text-shadow: 0 0 15px rgba(255,215,0,0.6); }
        .drop-zone-subtext { font-size: 16px; color: #b8860b; }
        .file-input { display: none; }
        .select-button { display: inline-block; margin: 20px 0; padding: 15px 40px; background: linear-gradient(135deg, rgba(184,134,11,0.6), rgba(212,175,55,0.6)); border: 2px solid #ffd700; color: #ffd700; font-family: 'Cinzel', serif; font-size: 18px; font-weight: 700; letter-spacing: 3px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .select-button:hover { background: linear-gradient(135deg, rgba(212,175,55,0.8), rgba(255,215,0,0.8)); box-shadow: 0 0 30px rgba(255,215,0,0.6); transform: translateY(-2px); }
        .status { background: rgba(26,10,46,0.8); border: 2px solid rgba(139,69,19,0.6); padding: 30px; margin: 30px 0; min-height: 150px; box-shadow: 0 8px 30px rgba(0,0,0,0.8); }
        .status-title { font-family: 'Cinzel', serif; font-size: 22px; color: #ffd700; margin-bottom: 15px; text-align: center; }
        .status-message { font-size: 18px; text-align: center; margin: 10px 0; }
        .progress { width: 100%; height: 30px; background: rgba(0,0,0,0.5); border: 2px solid rgba(212,175,55,0.4); margin: 20px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #b8860b, #ffd700, #b8860b); width: 0%; transition: width 0.3s ease; box-shadow: 0 0 20px rgba(255,215,0,0.6); }
        .file-list { margin: 20px 0; max-height: 300px; overflow-y: auto; }
        .file-item { padding: 10px; margin: 5px 0; background: rgba(0,0,0,0.3); border-left: 4px solid #8b4513; font-size: 16px; }
        .file-item.processed { border-left-color: #00ff00; color: #90ee90; }
        .download-button { display: inline-block; margin: 20px 0; padding: 20px 50px; background: linear-gradient(135deg, rgba(0,100,0,0.6), rgba(0,150,0,0.6)); border: 3px solid #00ff00; color: #00ff00; font-family: 'Cinzel', serif; font-size: 22px; font-weight: 900; letter-spacing: 4px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(0,0,0,0.5), 0 0 30px rgba(0,255,0,0.3); text-decoration: none; }
        .download-button:hover { background: linear-gradient(135deg, rgba(0,150,0,0.8), rgba(0,200,0,0.8)); box-shadow: 0 0 50px rgba(0,255,0,0.8); transform: translateY(-2px) scale(1.05); }
        @media(max-width:768px) { .title{font-size:28px} .bell-icon{font-size:70px} .drop-zone{padding:60px 20px} .drop-zone-icon{font-size:60px} }
    </style>
</head>
<body>
    <div class="fog-container">
        <div class="fog"></div><div class="fog"></div><div class="fog"></div>
    </div>

    <div class="page-wrapper">
        <header class="header">
            <div class="bell-icon">ğŸ””</div>
            <h1 class="title">THE SYNC BELL</h1>
            <p class="subtitle">Where .txt Files Become Immortal Gold ğŸ’</p>
        </header>

        <main class="content">

            <nav>
                <a href="https://kkk.education">â† HOME</a>
                <a href="https://kkk.education/library.html">ğŸ“š LIBRARY</a>
            </nav>

            <!-- â•â• MODE 1: AUTO SYNC FROM MANIFEST â•â• -->
            <div class="auto-sync-panel">
                <div class="auto-sync-title">ğŸ”” AUTO SYNC FROM CINEMA/BOOKS ğŸ””</div>
                <div class="auto-sync-desc">
                    Reads <code>manifest.json</code> from the root â†’ finds all <code>.txt</code> files in the <strong>BOOKS</strong> folder â†’
                    fetches them â†’ converts every one into a beautiful HTML book â†’
                    downloads as <code>library.zip</code> ready to upload.<br>
                    <small style="color:#b8860b;">any citizen can ring dis bell! same as da Sync Bell on REPUBLICKA.LIFE</small>
                </div>
                <button class="auto-sync-button" id="autoSyncBtn" onclick="autoSyncFromManifest()">
                    ğŸ”” RING DA BELL â€” AUTO GENERATE ğŸ””
                </button>
            </div>

            <div class="or-divider">â”â”â” OR â”â”â”</div>

            <!-- â•â• MODE 2: DRAG YOUR OWN FILES â•â• -->
            <div class="instructions">
                <h2>ğŸ“œ DRAG YOUR OWN .TXT FILES ğŸ“œ</h2>
                <p style="margin-bottom:20px;text-align:center;font-size:18px;color:#ffd700;">
                    <strong>ğŸª FOR KIDS WHO WRITE STORIES ğŸª</strong>
                </p>

                <div style="margin:20px 0;padding:20px;background:rgba(139,0,139,0.2);border:2px solid rgba(255,100,255,0.3);">
                    <h3 style="color:#ff69ff;margin-bottom:10px;text-align:center;">ğŸ“š FOR KIDS WHO WRITE STORIES ğŸ“š</h3>
                    <p style="font-size:16px;line-height:1.8;text-align:center;">
                        Write your stories in Notepad (or any .txt file)! ğŸ“<br>
                        Drag them onto this bell! ğŸ””<br>
                        Get beautiful HTML books you can open in ANY browser! ğŸ’<br>
                        <strong>NO WEBSITE NEEDED! NO INTERNET NEEDED!</strong><br>
                        Share them on USB drives, email, Discord, wherever! ğŸ‰<br>
                        <small style="color:#b8860b;">(You become a publisher with zero money! Your stories = immortal!)</small>
                    </p>
                </div>

                <div style="margin:20px 0;padding:20px;background:rgba(0,100,139,0.2);border:2px solid rgba(100,200,255,0.3);">
                    <h3 style="color:#69d9ff;margin-bottom:10px;text-align:center;">ğŸŒ FOR WEBSITE OWNERS ğŸŒ</h3>
                    <p style="font-size:16px;line-height:1.8;text-align:center;">
                        Use this to sync your entire library to your website! ğŸš€<br>
                        Drag ALL your .txt books, download the ZIP, extract it, upload the library/ folder!<br>
                        Works with library.html to create a searchable tomb library! ğŸ“š<br>
                        <small style="color:#b8860b;">(Perfect for KKK.EDUCATION or any book website!)</small>
                    </p>
                </div>

                <h3 style="color:#ffd700;margin:30px 0 15px;text-align:center;">âš¡ THE STEPS: âš¡</h3>
                <ol>
                    <li>ğŸ“š Get your .txt files ready (1 file or 100 files, doesn't matter!)</li>
                    <li>ğŸª <strong>DRAG them ALL</strong> onto the bell below (or click "Select Files" on phone)</li>
                    <li>âœ¨ Watch the MAGICKA happen (5â€“30 seconds depending on how many files)</li>
                    <li>ğŸ“¦ Download the library.zip file when it's ready</li>
                    <li>ğŸ—œï¸ Extract the ZIP (you'll get library/manifest.json + beautiful .html book files)</li>
                    <li>ğŸ’ <strong>Open the .html files in your browser</strong> (works offline!) OR upload to website!</li>
                </ol>
                <p style="margin-top:20px;text-align:center;font-size:16px;color:#ff69ff;">
                    ğŸ’€ <strong>DARK SECRET:</strong> This tool turns ANY .txt file into a beautiful eternal book!<br>
                    You don't need money, servers, or permission. Just words and a bell. ğŸ””<br>
                    <strong>Every kid becomes a publisher. Every story becomes immortal.</strong> ğŸ‘»âœ¨
                </p>
            </div>

            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-icon">ğŸ“šâœ¨ğŸ’€</div>
                <div class="drop-zone-text">DRAG YOUR .TXT FILES HERE</div>
                <div class="drop-zone-subtext">Or click to select files (works on phone too!)</div>
                <input type="file" id="fileInput" class="file-input" accept=".txt" multiple>
            </div>

            <div style="text-align:center;">
                <button class="select-button" onclick="document.getElementById('fileInput').click()">
                    ğŸ“± SELECT FILES (FOR PHONES) ğŸ“±
                </button>
            </div>

            <!-- â•â• SHARED STATUS PANEL â•â• -->
            <div class="status" id="status">
                <div class="status-title">ğŸ•¯ï¸ STATUS ğŸ•¯ï¸</div>
                <div class="status-message" id="statusMessage">
                    Ready and waiting... ğŸ’€<br>
                    <small style="color:#b8860b;">(The bell hungers for knowledge!)</small>
                </div>
                <div class="progress" id="progressContainer" style="display:none;">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="file-list" id="fileList"></div>
                <div style="text-align:center;" id="downloadContainer"></div>
            </div>

            <!-- SAVE THIS TOOL -->
            <div style="text-align:center;margin-top:40px;padding:24px;border:2px solid rgba(212,175,55,0.4);background:rgba(212,175,55,0.05);">
                <div style="font-family:'Cinzel',serif;font-size:0.9em;letter-spacing:0.3em;color:#ffd700;margin-bottom:10px;">ğŸ“¦ SAVE THIS TOOL</div>
                <p style="font-size:15px;color:#b8860b;margin-bottom:16px;line-height:1.7;">Save this page and use it anywhere â€” drag-and-drop works fully offline.<br>Auto-sync requires a live <code>https://</code> connection to fetch books.</p>
                <button onclick="window.open('https://kkk.education/sync-library.html','_blank')" style="padding:10px 24px;background:none;border:1px solid rgba(212,175,55,0.5);color:#b8860b;font-family:'Cinzel',serif;font-size:0.75em;letter-spacing:0.2em;cursor:pointer;margin:4px;">ğŸŒ OPEN LIVE VERSION</button>
                <button onclick="saveThisPage()" style="padding:10px 24px;background:none;border:1px solid rgba(212,175,55,0.5);color:#b8860b;font-family:'Cinzel',serif;font-size:0.75em;letter-spacing:0.2em;cursor:pointer;margin:4px;">ğŸ’¾ SAVE THIS FILE</button>
                <p id="saveStatus" style="margin-top:12px;font-size:13px;color:#b8860b;min-height:18px;"></p>
            </div>

        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        const MANIFEST_URL   = 'manifest.json';
        const BOOKS_FOLDER   = 'BOOKS';

        const dropZone          = document.getElementById('dropZone');
        const fileInput         = document.getElementById('fileInput');
        const statusMessage     = document.getElementById('statusMessage');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar       = document.getElementById('progressBar');
        const fileList          = document.getElementById('fileList');
        const downloadContainer = document.getElementById('downloadContainer');

        // â”€â”€ DRAG AND DROP (mode 2) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover',  (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.txt'));
            if (files.length > 0) processFiles(files);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) processFiles(Array.from(e.target.files));
        });

        // â”€â”€ MODE 1: AUTO SYNC FROM MANIFEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function autoSyncFromManifest() {
            const btn = document.getElementById('autoSyncBtn');
            btn.disabled = true;
            btn.textContent = 'â³ READING MANIFEST...';

            resetStatus();
            statusMessage.innerHTML = 'ğŸ”” Ringing the bell...<br><small>Reading manifest.json â†’ finding BOOKS folder...</small>';
            progressContainer.style.display = 'block';

            try {
                const res = await fetch(MANIFEST_URL, { cache: 'no-cache' });
                if (!res.ok) throw new Error('Could not load manifest.json (HTTP ' + res.status + ')');
                const manifest = await res.json();

                if (!manifest.items) throw new Error('manifest.json has no items â€” is this the cinema manifest?');

                const booksFolder = manifest.items.find(i => i.type === 'folder' && i.name === BOOKS_FOLDER);
                if (!booksFolder) throw new Error('"' + BOOKS_FOLDER + '" folder not found in manifest.json');

                const txtFiles = [];
                function collectTxt(items) {
                    items.forEach(item => {
                        if (item.type === 'folder') collectTxt(item.children || []);
                        else if (item.type === 'file' && item.name.toLowerCase().endsWith('.txt')) {
                            txtFiles.push({ name: item.name, url: item.path });
                        }
                    });
                }
                collectTxt(booksFolder.children || []);

                if (!txtFiles.length) throw new Error('No .txt files found in the BOOKS folder of manifest.json');

                statusMessage.innerHTML = 'ğŸ”” Found <strong>' + txtFiles.length + '</strong> books! Fetching and converting...<br><small>(this may take a moment)</small>';
                btn.textContent = 'â³ FETCHING ' + txtFiles.length + ' BOOKS...';

                const tomes  = [];
                const zip    = new JSZip();
                const libDir = zip.folder('library');
                let done = 0;

                for (const f of txtFiles) {
                    const fileEl = document.createElement('div');
                    fileEl.className = 'file-item';
                    fileEl.textContent = 'â³ Fetching â€” ' + f.name;
                    fileList.appendChild(fileEl);

                    let text = '';
                    try {
                        const r = await fetch(f.url);
                        if (!r.ok) throw new Error('HTTP ' + r.status);
                        text = await r.text();
                        fileEl.className = 'file-item processed';
                        fileEl.textContent = 'âœ… Done â€” ' + f.name;
                    } catch (err) {
                        fileEl.className = 'file-item';
                        fileEl.textContent = 'âŒ Failed â€” ' + f.name + ' (' + err.message + ')';
                    }

                    const filename = f.name.replace(/\.txt$/i, '');
                    const title    = prettifyTitle(filename);
                    const match    = filename.match(/^(\d+)[-_\s]/);
                    const tomeData = { filename, title };
                    if (match) tomeData.number = parseInt(match[1], 10);
                    tomes.push(tomeData);

                    libDir.file(filename + '.html', generateBookHTML(title, text));

                    done++;
                    progressBar.style.width = (done / txtFiles.length * 100) + '%';
                    await new Promise(r => setTimeout(r, 0));
                }

                libDir.file('manifest.json', JSON.stringify({ tomes }, null, 2));
                statusMessage.innerHTML = 'ğŸ“¦ Packing library.zip... almost there!';
                const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
                statusMessage.innerHTML = 'âš¡ MAGICKA COMPLETE! âš¡<br><small>Fetched and converted ' + done + ' books! ğŸ’</small>';
                showDownload(URL.createObjectURL(blob));

            } catch (err) {
                statusMessage.innerHTML = 'âŒ Error: ' + err.message + '<br><small style="color:#b8860b;">Make sure manifest.json is in the site root and BOOKS folder exists.</small>';
                progressContainer.style.display = 'none';
            }

            btn.disabled = false;
            btn.textContent = 'ğŸ”” RING DA BELL â€” AUTO GENERATE ğŸ””';
        }

        // â”€â”€ MODE 2: DRAG FILES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function processFiles(files) {
            resetStatus();
            statusMessage.innerHTML = 'ğŸ”” RING RING! The bell awakens! ğŸ””<br>Processing ' + files.length + ' file(s)...';
            progressContainer.style.display = 'block';

            const tomes  = [];
            const zip    = new JSZip();
            const libDir = zip.folder('library');
            let processed = 0;

            for (const file of files) {
                const filename = file.name.replace(/\.txt$/i, '');
                const content  = await readFile(file);
                const title    = prettifyTitle(filename);

                const fileEl = document.createElement('div');
                fileEl.className = 'file-item processed';
                fileEl.textContent = 'âœ… DONE â€” ' + file.name;
                fileList.appendChild(fileEl);

                const match    = filename.match(/^(\d+)[-_\s]/);
                const tomeData = { filename, title };
                if (match) tomeData.number = parseInt(match[1], 10);
                tomes.push(tomeData);

                libDir.file(filename + '.html', generateBookHTML(title, content));

                processed++;
                progressBar.style.width = (processed / files.length * 100) + '%';
            }

            libDir.file('manifest.json', JSON.stringify({ tomes }, null, 2));
            statusMessage.innerHTML = 'âš¡ MAGICKA COMPLETE! âš¡<br><small>Processed: ' + processed + ' files! ğŸ’</small>';
            showDownload(URL.createObjectURL(await zip.generateAsync({ type: 'blob' })));
        }

        // â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function resetStatus() {
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
            fileList.innerHTML = '';
            downloadContainer.innerHTML = '';
        }

        function showDownload(url) {
            downloadContainer.innerHTML =
                '<a href="' + url + '" download="library.zip" class="download-button">ğŸ’ DOWNLOAD LIBRARY.ZIP ğŸ’</a>' +
                '<p style="margin-top:15px;font-size:16px;color:#90ee90;">âœ… Extract and upload the library/ folder to your website! ğŸš€</p>';
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload  = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function prettifyTitle(filename) {
            let s = filename.replace(/^\d+[-_\s]+/, '').replace(/[-_]+/g, ' ');
            return s.trim().toUpperCase();
        }

        function generateBookHTML(title, content) {
            const escaped = content
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title} - KKK.EDUCATION</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        body { background:#000000; color:#d4af37; font-family:'Crimson Text',serif; line-height:1.8; padding:40px 20px; }
        .container { max-width:800px; margin:0 auto; }
        .header { text-align:center; margin-bottom:40px; padding-bottom:30px; border-bottom:2px solid rgba(212,175,55,0.3); }
        h1 { font-family:'Cinzel',serif; font-size:32px; font-weight:900; color:#ffd700; letter-spacing:4px; margin-bottom:20px; text-shadow:0 0 20px rgba(255,215,0,0.6); }
        .back-link { display:inline-block; margin-top:20px; padding:10px 30px; background:rgba(139,69,19,0.4); border:2px solid rgba(212,175,55,0.6); color:#d4af37; text-decoration:none; font-family:'Cinzel',serif; font-size:16px; letter-spacing:2px; transition:all 0.3s; }
        .back-link:hover { background:rgba(184,134,11,0.6); color:#ffd700; border-color:#ffd700; }
        .content { text-align:center; font-size:18px; white-space:pre-wrap; word-wrap:break-word; }
        footer { text-align:center; margin-top:60px; padding-top:30px; border-top:2px solid rgba(139,69,19,0.6); font-size:14px; color:#b8860b; }
        @media(max-width:768px){ body{padding:30px 15px} h1{font-size:24px} .content{font-size:16px} }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${title}</h1>
            <a href="../library.html" class="back-link">â† Back to Library</a>
        </div>
        <div class="content">${escaped}</div>
        <footer>
            <p>CC0 PUBLICKÃ DOMÃNIA â€¢ ALL LOVE RESERVED</p>
            <p style="margin-top:10px;">AMORIARIACKA IS MY NATIVE TONGUE</p>
        </footer>
    </div>
</body>
</html>`;
        }

        async function saveThisPage() {
            const status = document.getElementById('saveStatus');
            status.textContent = 'â³ Fetching...';
            try {
                const res = await fetch('https://kkk.education/sync-library.html');
                var text  = await res.text();
                var blob  = new Blob([text], {type: 'text/html'});
                var a     = document.createElement('a');
                a.href    = URL.createObjectURL(blob);
                a.download = 'sync-library.html';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                status.textContent = 'âœ… Saved! Drag-and-drop works fully offline.';
            } catch(e) {
                status.textContent = 'âŒ ' + e.message + ' â€” try File > Save Page As instead.';
            }
        }
    </script>
</body>
</html>